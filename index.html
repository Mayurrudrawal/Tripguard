<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TripGuard - Tourist Safety System (Demo)</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <style>
      :root {
        --primary: #2563eb;
        --primary-dark: #1e40af;
        --secondary: #64748b;
        --success: #22c55e;
        --warning: #f59e0b;
        --danger: #ef4444;
        --light: #f8fafc;
        --dark: #1e293b;
        --gray: #94a3b8;
        --background: #f1f5f9;
        --card: #ffffff;
        --sidebar: #1e2a38;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--background);
        color: var(--dark);
        line-height: 1.5;
      }
      .container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 18px;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: var(--card);
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
        margin-bottom: 16px;
      }
      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .logo h1 {
        color: var(--primary);
        font-size: 20px;
      }
      .tabs {
        background: var(--card);
        border-radius: 10px;
        padding: 0;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        margin-bottom: 16px;
      }
      .tab-headers {
        display: flex;
        background: var(--light);
        border-radius: 10px 10px 0 0;
        overflow: hidden;
      }
      .tab-btn {
        flex: 1;
        padding: 12px;
        text-align: center;
        border: 0;
        background: none;
        cursor: pointer;
        color: var(--secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
      .tab-btn.active {
        background: var(--card);
        color: var(--primary);
        border-bottom: 3px solid var(--primary);
      }
      .tab-content {
        padding: 16px;
        min-height: 520px;
      }
      .tab-pane {
        display: none;
      }
      .tab-pane.active {
        display: block;
      }
      .mobile-frame {
        width: 390px;
        height: 844px;
        margin: 0 auto;
        background: var(--card);
        border-radius: 30px;
        overflow: hidden;
        border: 10px solid #1e293b;
      }
      .mobile-content {
        padding: 16px;
        height: 100%;
        overflow: auto;
      }
      .score-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 8px auto;
        background: linear-gradient(90deg, #22c55e, #f59e0b);
      }
      .score-inner {
        width: 100px;
        height: 100px;
        background: white;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .map-container {
        height: 220px;
        background: linear-gradient(90deg, #f8fafc, #eef2ff);
        border-radius: 12px;
        position: relative;
        overflow: hidden;
        margin: 12px 0;
      }
      #map,
      #auth-map {
        height: 100%;
        width: 100%;
      }
      .action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin: 8px 0;
      }
      .btn {
        padding: 10px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-danger {
        background: var(--danger);
        color: white;
      }
      .btn-outline {
        background: transparent;
        border: 1px solid var(--primary);
        color: var(--primary);
      }
      .panic-btn {
        grid-column: span 2;
        background: var(--danger);
        color: white;
        padding: 14px;
        font-size: 16px;
      }
      .features,
      .instructions {
        margin-top: 16px;
      }
      .dashboard {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 14px;
      }
      .sidebar {
        background: var(--sidebar);
        color: white;
        padding: 12px;
        border-radius: 8px;
      }
      .sidebar-item {
        padding: 10px;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 4px;
      }
      .sidebar-item.active {
        background: var(--primary);
      }
      .card {
        background: var(--card);
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 8px;
        border-bottom: 1px solid #eee;
        text-align: left;
      }
      .heatmap-container {
        height: 220px;
        border-radius: 8px;
        overflow: hidden;
      }
      .badge {
        background: #f3f4f6;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
      }
      .alert-item {
        padding: 10px;
        border-left: 4px solid var(--danger);
        background: #fff0f0;
        border-radius: 6px;
        margin-bottom: 8px;
      }
      .muted {
        color: var(--secondary);
        font-size: 13px;
      }
      .hidden {
        display: none;
      }
      .route-risk-highlight {
        animation: pulse-risk 2s infinite;
      }

      @keyframes pulse-risk {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
      }
      .cluster-marker {
        background: var(--primary);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
      input,
      textarea,
      select {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      @media (max-width: 900px) {
        .dashboard {
          grid-template-columns: 1fr;
        }
        .mobile-frame {
          width: 100%;
          height: 600px;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/main.tsx"></script>
    <div class="container">
      <div id="login-screen">
        <div class="card" style="max-width: 420px; margin: 30px auto">
          <div style="text-align: center; margin-bottom: 10px">
            <div class="logo" style="justify-content: center">
              <i class="fas fa-shield-alt" style="font-size: 28px; color: var(--primary)"></i>
              <h1>TripGuard</h1>
            </div>
            <p class="muted">Tourist Safety Platform — Demo</p>
          </div>
          <div style="margin-top:10px">
            <label>Role</label>
            <select id="role-select" style="width:100%;padding:10px;border-radius:6px;border:1px solid #ddd;margin-top:6px">
              <option value="tourist">Tourist</option>
              <option value="authority">Authority</option>
            </select>
          </div>
          <div style="margin-top: 12px">
            <label>Email</label>
            <input id="email" type="email" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd; margin-top: 6px;"/>
          </div>
          <div style="margin-top: 10px">
            <label>Password</label>
            <input id="password" type="password" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd; margin-top: 6px;"/>
          </div>
          <div id="tourist-kyc" style="margin-top:10px">
            <label style="display:block;margin-bottom:6px">Identity Type</label>
            <select id="id-type" style="width:100%;padding:10px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px">
              <option value="aadhar" selected>Aadhar</option>
              <option value="passport">Passport</option>
            </select>
            <div id="kyc-aadhar">
              <label>Aadhar Number</label>
              <input id="aadhar" maxlength="12" placeholder="Enter 12-digit Aadhar" style="width:100%;padding:10px;border-radius:6px;border:1px solid #ddd;margin-top:6px"/>
            </div>
            <div id="kyc-passport" style="display:none">
              <label>Passport Number</label>
              <input id="passport" maxlength="8" placeholder="Format: A1234567" style="width:100%;padding:10px;border-radius:6px;border:1px solid #ddd;margin-top:6px;text-transform:uppercase"/>
            </div>
          </div>
          <div id="authority-fields" style="margin-top:10px;display:none">
            <label>Authority ID</label>
            <input id="authority-id" style="width:100%;padding:10px;border-radius:6px;border:1px solid #ddd;margin-top:6px"/>
          </div>
          <div style="margin-top: 12px; display: flex; gap: 8px">
            <button id="btn-login" class="btn btn-primary" onclick="login()" data-i18n="login">Login</button>
            <button id="btn-register" class="btn btn-outline" onclick="register()" data-i18n="register">Register</button>
          </div>
          <div style="text-align:center;margin-top:8px;color:var(--secondary);font-size:13px">Tip: Use any email/password for demo.</div>
        </div>
      </div>

      <div id="app-container" class="hidden">
        <header>
          <div style="display: flex; align-items: center; gap: 12px">
            <i
              class="fas fa-shield-alt"
              style="font-size: 20px; color: var(--primary)"
            ></i>
            <div>
              <h1 style="margin: 0; font-size: 18px">TripGuard</h1>
              <div class="muted" id="user-info">Welcome</div>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 12px">
            <div class="muted" id="header-safety">Safety Score: --</div>
            <div class="muted" id="alert-count-display">0 Active Alerts</div>
            <button class="btn btn-outline" onclick="logout()">Logout</button>
          </div>
        </header>

        <div class="tabs">
          <div class="tab-headers" role="tablist">
            <button
              id="tab-tourist"
              class="tab-btn active"
              data-tab="tourist"
              onclick="switchTab(event,'tourist')"
            >
              <i class="fas fa-mobile-alt"></i>
              <span data-i18n="tourist_interface">Tourist Interface</span>
            </button>
            <button
              id="tab-authority"
              class="tab-btn"
              data-tab="authority"
              onclick="switchTab(event,'authority')"
            >
              <i class="fas fa-desktop"></i>
              <span data-i18n="authority_dashboard">Authority Dashboard</span>
              <span class="badge" id="authority-count">0</span>
            </button>
            <button
              id="tab-analytics"
              class="tab-btn"
              data-tab="analytics"
              onclick="switchTab(event,'analytics')"
            >
              <i class="fas fa-chart-line"></i>
              <span data-i18n="analytics">Analytics</span>
            </button>
          </div>
          <div class="tab-content">
            <div class="tab-pane active" id="tourist-tab">
              <div class="mobile-frame">
                <div class="mobile-content">
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                    "
                  >
                    <div>
                      <strong id="tourist-name">Tourist</strong>
                      <div class="muted" id="tourist-id">ID: --</div>
                    </div>
                    <div>
                      <select
                        id="language-select"
                        style="padding: 6px; border-radius: 6px"
                      >
                        <option value="en" selected>English</option>
                        <option value="hi">हिन्दी</option>
                        <option value="bn">বাংলা</option>
                        <option value="mr">मराठी</option>
                        <option value="te">తెలుగు</option>
                        <option value="ta">தமிழ்</option>
                        <option value="kn">ಕನ್ನಡ</option>
                        <option value="ml">മലയാളം</option>
                        <option value="gu">ગુજરાતી</option>
                        <option value="pa">ਪੰਜਾਬੀ</option>
                        <option value="or">ଓଡ଼ିଆ</option>
                        <option value="as">অসমীয়া</option>
                      </select>
                    </div>
                  </div>

                  <div class="score-circle" id="safety-circle">
                    <div class="score-inner">
                      <div
                        id="safety-score"
                        style="font-size: 20px; font-weight: 700"
                      >
                        --
                      </div>
                      <div class="muted" style="font-size: 13px">Safety</div>
                    </div>
                  </div>

                  <div class="map-container card" style="padding: 0">
                    <div id="map"></div>
                  </div>

                  <div style="margin-top: 8px">
                    <small class="muted"
                      >Plan your route, see safe route, and start tracking.
                      Police/hospitals are shown on the map</small
                    >
                  </div>

                  <div class="action-buttons">
                    <button
                      id="btn-route"
                      class="btn btn-primary"
                      onclick="openRoutePlanner()"
                      data-i18n="route_planner"
                    >
                      Route Planner
                    </button>
                    <button
                      id="btn-family"
                      class="btn btn-primary"
                      onclick="toggleFamilyTracking(true)"
                      data-i18n="start_family"
                    >
                      Start Family Tracking
                    </button>
                    <button
                      id="btn-share"
                      class="btn btn-outline"
                      onclick="shareLocation()"
                      data-i18n="share_location"
                    >
                      Share Location
                    </button>
                    <button
                      id="btn-itinerary"
                      class="btn btn-outline"
                      onclick="showItinerary()"
                      data-i18n="my_itinerary"
                    >
                      My Itinerary
                    </button>
                    <button
                      id="btn-panic"
                      class="panic-btn"
                      onclick="triggerPanicAlert()"
                    >
                      <i class="fas fa-bell"></i> 🚨
                      <span data-i18n="panic">Panic</span>
                    </button>
                  </div>

                  <div style="margin-top: 12px">
                    <button
                      id="btn-voice"
                      class="btn btn-outline"
                      onclick="startVoiceControl()"
                      data-i18n="voice_control"
                    >
                      Start Voice Control (say 'panic')
                    </button>
                    <div style="margin-top: 8px">
                      <h4>Feedback</h4>
                      <div style="display: flex; gap: 6px; margin-bottom: 6px">
                        <i
                          class="fas fa-star"
                          id="star1"
                          onclick="setRating(1)"
                          style="cursor: pointer; color: #ccc"
                        ></i>
                        <i
                          class="fas fa-star"
                          id="star2"
                          onclick="setRating(2)"
                          style="cursor: pointer; color: #ccc"
                        ></i>
                        <i
                          class="fas fa-star"
                          id="star3"
                          onclick="setRating(3)"
                          style="cursor: pointer; color: #ccc"
                        ></i>
                        <i
                          class="fas fa-star"
                          id="star4"
                          onclick="setRating(4)"
                          style="cursor: pointer; color: #ccc"
                        ></i>
                        <i
                          class="fas fa-star"
                          id="star5"
                          onclick="setRating(5)"
                          style="cursor: pointer; color: #ccc"
                        ></i>
                      </div>
                      <textarea
                        id="feedback-input"
                        rows="3"
                        style="
                          width: 100%;
                          padding: 8px;
                          border-radius: 6px;
                          border: 1px solid #ddd;
                        "
                      ></textarea>
                      <div style="margin-top: 6px; display: flex; gap: 8px">
                        <button
                          class="btn btn-primary"
                          onclick="submitFeedback()"
                        >
                          Submit
                        </button>
                        <button
                          class="btn btn-outline"
                          onclick="viewFeedback()"
                        >
                          View Feedback
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane" id="authority-tab">
              <div class="dashboard">
                <div class="sidebar">
                  <div
                    style="
                      background: var(--primary);
                      padding: 8px;
                      border-radius: 6px;
                      margin-bottom: 8px;
                    "
                  >
                    <div><strong>Authority</strong></div>
                    <div class="muted">ID: AUTH-001</div>
                  </div>
                  <div style="display: flex; flex-direction: column; gap: 6px">
                    <div
                      class="sidebar-item active"
                      onclick="switchAuthorityTab(event,'monitoring')"
                    >
                      <i class="fas fa-users"></i> Monitoring
                    </div>
                    <div
                      class="sidebar-item"
                      onclick="switchAuthorityTab(event,'risk-zones')"
                    >
                      <i class="fas fa-exclamation-triangle"></i> Risk Zones
                    </div>
                    <div
                      class="sidebar-item"
                      onclick="switchAuthorityTab(event,'alerts')"
                    >
                      <i class="fas fa-bell"></i> Alerts
                    </div>
                    <div
                      class="sidebar-item"
                      onclick="switchAuthorityTab(event,'efir')"
                    >
                      <i class="fas fa-file-alt"></i> E-FIR
                    </div>
                  </div>
                </div>

                <div class="main-content">
                  <div class="card" id="authority-monitoring">
                    <div
                      style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                      "
                    >
                      <h3>Tourist Cluster Heatmap</h3>
                      <div class="muted">Simulated clusters</div>
                    </div>
                    <div
                      id="auth-map"
                      class="heatmap-container"
                      style="margin-top: 8px"
                    ></div>
                    <div style="margin-top: 8px">
                      <h4>Cluster summary</h4>
                      <div
                        id="cluster-list"
                        style="display: flex; gap: 8px; flex-wrap: wrap"
                      ></div>
                    </div>
                  </div>

                  <div style="display: flex; flex-direction: column; gap: 12px">
                    <div class="card">
                      <div
                        style="
                          display: flex;
                          justify-content: space-between;
                          align-items: center;
                        "
                      >
                        <h4 data-i18n="active_alerts">Active Alerts</h4>
                        <div class="badge" id="authority-alert-count">0</div>
                      </div>
                      <div id="alerts-list" style="margin-top: 8px"></div>
                    </div>

                    <div class="card" id="efir-card" style="display: none">
                      <h4>Generate E-FIR</h4>
                      <div
                        style="display: flex; flex-direction: column; gap: 8px"
                      >
                        <input
                          id="efir-name"
                          placeholder="Tourist Name"
                          style="
                            padding: 8px;
                            border-radius: 6px;
                            border: 1px solid #ddd;
                          "
                        />
                        <input
                          id="efir-id"
                          placeholder="Tourist ID"
                          style="
                            padding: 8px;
                            border-radius: 6px;
                            border: 1px solid #ddd;
                          "
                        />
                        <input
                          id="efir-location"
                          placeholder="Last known location"
                          style="
                            padding: 8px;
                            border-radius: 6px;
                            border: 1px solid #ddd;
                          "
                        />
                        <textarea
                          id="efir-details"
                          rows="4"
                          placeholder="Details..."
                          style="
                            padding: 8px;
                            border-radius: 6px;
                            border: 1px solid #ddd;
                          "
                        ></textarea>
                        <div style="display: flex; gap: 8px">
                          <button
                            class="btn btn-primary"
                            onclick="generateEFIR()"
                          >
                            Generate & Download
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane" id="analytics-tab">
              <div class="card">
                <h3>Analytics & Simulations</h3>
                <p class="muted">
                  Behavior detection (simulated) — route deviation, inactivity,
                  dropoffs.
                </p>
                <div style="display: flex; gap: 12px; margin-top: 8px">
                  <button class="btn btn-outline" onclick="simulateDeviation()">
                    Simulate Deviation
                  </button>
                  <button class="btn btn-outline" onclick="simulateDropoff()">
                    Simulate Drop-off
                  </button>
                  <button
                    class="btn btn-outline"
                    onclick="simulateInactivity()"
                  >
                    Simulate Inactivity
                  </button>
                </div>
                <div id="analytics-log" style="margin-top: 12px"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function () {
        let currentUser = null,
          touristId = null;
        let map,
          authMap,
          safePolyline = null,
          heatLayer = null,
          clusterMarkers = [];
        let userMarker = null,
          familyMarker = null,
          familyInterval = null,
          trackingWatchId = null,
          riskPolygon = null,
          riskZones = [],
          moderateZones = [],
          safeZones = [];
        let activeAlerts = JSON.parse(
          localStorage.getItem("tripguard_alerts") || "[]",
        );
        let feedbackList = JSON.parse(
          localStorage.getItem("tripguard_feedback") || "[]",
        );
        let safetyScore = 80,
          plannedRoute = null,
          uiLanguage = "en",
          speechRec = null;
        let lastPosition = null,
          stationaryStartTime = null,
          inactivityTimer = null,
          ratingValue = 0;

        const policeStations = [
          { name: "Guwahati Police Control", phone: "+91 361-252-1242", pos: { lat: 26.1783, lng: 91.745 } },
          { name: "Shillong Police HQ", phone: "+91 364-222-2277", pos: { lat: 25.5788, lng: 91.8933 } },
          { name: "Itanagar Police", phone: "+91 360-221-2262", pos: { lat: 27.0844, lng: 93.6053 } },
        ];
        const hospitals = [
          { name: "Guwahati Medical College", pos: { lat: 26.1852, lng: 91.7732 } },
          { name: "NEIGRIHMS Shillong", pos: { lat: 25.613, lng: 91.9387 } },
          { name: "TRIHMS Naharlagun", pos: { lat: 27.1103, lng: 93.686 } },
        ];

        const TTS_PHRASES = {
          en: {
            enteredRisk: "Warning: you have entered a high risk zone",
            offRoute: "Warning: you are off the planned route",
            stillness:
              "You have been stationary for a while. If this is an emergency, press the panic button.",
          },
          hi: {
            enteredRisk:
              "चेतावनी: आप उच्च जोखिम वाले क्षेत्र में प्रवेश कर गए हैं",
            offRoute: "चेतावनी: आप योजना से बाहर हैं",
            stillness:
              "आप कुछ समय से एक ही स्थान पर हैं। यदि यह आपातकाल है, तो पैनिक बटन दबाएँ।",
          },
          bn: {
            enteredRisk: "সতর্কতা: আপনি উচ্চ ঝুঁকিপূর্ণ এলাকায় প্রবেশ করেছেন",
            offRoute: "সতর্কতা: আপনি পরিকল্পিত রুট থেকে বিচ্যুত হয়েছেন",
            stillness:
              "আপনি কিছুক্ষণ ধরে একই জায়গায় আছেন। জরুরি অবস্থা হলে প্যানিক বোতাম চাপুন।",
          },
          mr: {
            enteredRisk: "सावधान: आपण उच्च धोका क्षेत्रात प्रवेश केला आहे",
            offRoute: "सावधान: आपण नियोजित मार्गावरून बाहेर आला आहात",
            stillness:
              "आपण काही काळ एकाच ठिकाणी आहात. आणीबाणी असल्यास पॅनिक बटण दाबा.",
          },
          te: {
            enteredRisk: "హెచ్చరిక: మీరు అధిక ప్రమాద ప్రాంతంలోకి ప్రవేశించారు",
            offRoute: "హెచ్చరిక: మీరు ప్రణాళిక మార్గం నుండి దూరమయ్యారు",
            stillness:
              "మీరు కొంతకాలంగా ఒకే చోట ఉన్నారు. అత్యవసరం అయితే పానిక్ బటన్ నొక్కండి.",
          },
          ta: {
            enteredRisk:
              "எச்சரிக்கை: நீங்கள் அதிக ஆபத்து நிறைந்த பகுதியில் நுழைந்துவிட்டீர்கள்",
            offRoute: "எச்சரிக்கை: நீங்கள் திட்டமிட்ட பாதையில் இல்லை",
            stillness:
              "நீங்கள் சில நேரமாக ஒரே இடத்தில் இருக்கிறீர்கள். அவசரம் என்றால் பீதி பொத்தானை அழுத்தவும்.",
          },
          kn: {
            enteredRisk:
              "ಎಚ್ಚರಿಕೆ: ನೀವು ಹೆಚ್ಚಿನ ಅಪಾಯದ ವಲಯವನ್ನು ಪ್ರವೇಶಿಸಿದ್ದೀರಿ",
            offRoute: "ಎಚ್ಚರಿಕೆ: ನೀವು ಯೋಜಿತ ಮಾರ್ಗದಿಂದ ದೂರ ಸರಿದಿದ್ದೀರಿ",
            stillness:
              "ನೀವು ಕೆಲವು ಸಮಯದಿಂದ ಒಂದೇ ಸ್ಥಳದಲ್ಲಿದ್ದೀರಿ. ತುರ್ತು ಪರಿಸ್ಥಿತಿಯಿದ್ದರೆ ಪ್ಯಾನಿಕ್ ಬಟನ್ ಒತ್ತಿರಿ.",
          },
          ml: {
            enteredRisk:
              "മുന്നറിയിപ്പ്: നിങ്ങൾ ഉയർന്ന അപകട സാധ്യതയുള്ള മേഖലയിലേക്ക് പ്രവേശിച്ചു",
            offRoute:
              "മുന്നറിയിപ്പ്: നിങ്ങൾ പദ്ധതി മാർഗത്തിൽ നിന്ന് വ്യതിചലിച്ചിരിക്കുന്നു",
            stillness:
              "നിങ്ങൾ കുറച്ച് സമയമായി ഒരേ സ്ഥലത്താണ്. അടിയന്തിര സ്ഥിതിയാണെങ്കിൽ പാനിക് ബട്ടൺ അമർത്തുക.",
          },
          gu: {
            enteredRisk: "ચેતવણી: તમે ઉચ્ચ જોખમવાળા વિસ્તારમાં દાખલ થયા છો",
            offRoute: "ચેતવણી: તમે આયોજનબદ્ધ માર્ગથી ભટકી ગયા છો",
            stillness:
              "તમે થોડા સમયથી એક જ સ્થળે છો. તાત્કાલિક સ્થિતિ હોય તો પેનિક બટન દબાવો.",
          },
          pa: {
            enteredRisk: "ਚੇਤਾਵਨੀ: ਤੁਸੀਂ ਉੱਚ-ਖਤਰੇ ਵਾਲੇ ਖੇਤਰ ਵਿੱਚ ਦਾਖਲ ਹੋ ਗਏ ਹੋ",
            offRoute: "ਚੇਤਾਵਨੀ: ਤੁਸੀਂ ਯੋਜਨਾਬੱਧ ਮਾਰਗ ਤੋਂ ਭਟਕ ਗਏ ਹੋ",
            stillness:
              "ਤੁਸੀਂ ਕੁਝ ਸਮੇਂ ਤੋਂ ਇੱਕੇ ਥਾਂ 'ਤੇ ਹੋ। ਜੇ ਐਮਰਜੈਂਸੀ ਹੈ ਤਾਂ ਪੈਨਿਕ ਬਟਨ ਦਬਾਓ।",
          },
          or: {
            enteredRisk: "ଚେତାବନୀ: ଆପଣ ଉଚ୍ଚ ବିପଦ ଅଞ୍ଚଳରେ ପ୍ରବେଶ କରିଛନ୍ତି",
            offRoute: "ଚେତାବନୀ: ଆପଣ ଯୋଜିତ ମାର୍ଗରୁ ବିଚ୍ୟୁତ ହୋଇଛନ୍ତି",
            stillness:
              "ଆପଣ କିଛି ସମୟ ଧରି ଗୋଟିଏ ସ୍ଥାନରେ ଅଛନ୍ତି। ଯଦି ଆପତ୍କାଳ ଅଛି, ପ୍ୟାନିକ୍ ବଟନ୍ ଦବାନ୍ତୁ।",
          },
          as: {
            enteredRisk: "সতৰ্কতা: আপুনি উচ্চ বিপদসংকুল অঞ্চলত প্ৰৱেশ কৰিছে",
            offRoute: "সতৰ্কতা: আপুনি পৰিকল্পিত পথৰ পৰা বিচ্যুত হৈছে",
            stillness:
              "আপুনি অলপ সময় ধৰি একে ঠাইত আছে। জৰুৰী হ'লে পেনিক বুটাম টিপক।",
          },
        };

        const $ = (s) => document.querySelector(s);
        function uuidv4() {
          return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
            /[xy]/g, (c) => {
              const r = (Math.random() * 16) | 0,
                v = c === "x" ? r : (r & 0x3) | 0x8;
              return v.toString(16);
            },
          );
        }
        function speak(msg) {
          try {
            if (!msg) return;
            const u = new SpeechSynthesisUtterance(msg);
            u.lang = uiLanguage;
            speechSynthesis.cancel();
            speechSynthesis.speak(u);
          } catch {}
        }
        function ttsKey(k) {
          const m = TTS_PHRASES[uiLanguage] || TTS_PHRASES.en;
          return m[k] || "";
        }
        function saveAlerts() {
          localStorage.setItem(
            "tripguard_alerts",
            JSON.stringify(activeAlerts),
          );
          renderAlerts();
        }
        function saveFeedbackList() {
          localStorage.setItem(
            "tripguard_feedback",
            JSON.stringify(feedbackList),
          );
        }
        function addAlert(obj) {
          activeAlerts.unshift(obj);
          saveAlerts();
          updateCounts();
          if (obj.type === "Panic" || obj.priority === "High") {
            notify(`🚨 ${obj.name || obj.touristId} — ${obj.type}`);
          }
        }
        function notify(msg) {
          if ("Notification" in window) {
            if (Notification.permission === "granted")
              new Notification("TripGuard Alert", { body: msg });
            else if (Notification.permission === "default")
              Notification.requestPermission();
          }
        }
        function updateCounts() {
          $("#alert-count-display").textContent =
            activeAlerts.length + " Active Alerts";
          $("#authority-count").textContent = activeAlerts.length;
          $("#authority-alert-count").textContent = activeAlerts.length;
        }

        function handleGeoError(err) {
          let msg = "Unable to access location.";
          if (err && typeof err.code === "number") {
            if (err.code === 1)
              msg =
                "Location permission denied. Enable location to use live features.";
            else if (err.code === 2)
              msg = "Location unavailable. Try again later.";
            else if (err.code === 3) msg = "Location request timed out.";
          }
          console.warn(
            "Geolocation error:",
            err && err.message ? err.message : err,
          );
          if (!document.querySelector(".geo-toast")) {
            const d = document.createElement("div");
            d.className = "geo-toast";
            d.style.cssText =
              "position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#fff;border:1px solid #eee;border-radius:8px;padding:8px 12px;box-shadow:0 2px 10px rgba(0,0,0,.08);z-index:9999;font-size:13px;color:#1e293b";
            d.textContent = msg;
            document.body.appendChild(d);
            setTimeout(() => d.remove(), 3500);
          }
        }

        // Init maps with Leaflet
        function initMaps() {
          const center = [26.1445, 91.7362]; // Guwahati
          map = L.map("map").setView(center, 13);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "&copy; OpenStreetMap",
          }).addTo(map);

          authMap = L.map("auth-map").setView(center, 10);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
          }).addTo(authMap);

          userMarker = L.circleMarker(center, {
            radius: 8,
            color: "#ffffff",
            weight: 2,
            fillColor: "#2563eb",
            fillOpacity: 1,
          }).addTo(map);

          // Create enhanced zones with better visualization
          createEnhancedZones();
          
          // Add POIs
          policeStations.forEach((p) => {
            L.marker([p.pos.lat, p.pos.lng])
              .addTo(map)
              .addTo(authMap)
              .bindPopup(`<b>${p.name}</b><br>${p.phone}`);
          });
          
          hospitals.forEach((h) => {
            L.marker([h.pos.lat, h.pos.lng])
              .addTo(map)
              .addTo(authMap)
              .bindPopup(`<b>${h.name}</b><br>Hospital`);
          });

          if (navigator.geolocation && currentUser?.type === "tourist") {
            navigator.geolocation.getCurrentPosition(
              (pos) => {
                const ll = [pos.coords.latitude, pos.coords.longitude];
                userMarker.setLatLng(ll);
                map.setView(ll, 15);
                updateUserLocationUI({ lat: ll[0], lng: ll[1] });
                
                // Add tourist to storage
                updateTouristStatus(touristId, { 
                  position: { lat: ll[0], lng: ll[1] },
                  lastUpdate: new Date().toISOString()
                });
              },
              handleGeoError,
              { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 },
            );
            
            startTracking();
          }

          generateAuthClusters();
          renderAlerts();
          updateCounts();
        }

        // New function to create enhanced zones
        function createEnhancedZones() {
          // Clear existing zones
          riskZones.forEach(zone => {
            map.removeLayer(zone);
            authMap.removeLayer(zone);
          });
          moderateZones.forEach(zone => {
            map.removeLayer(zone);
            authMap.removeLayer(zone);
          });
          safeZones.forEach(zone => {
            map.removeLayer(zone);
            authMap.removeLayer(zone);
          });
          
          riskZones = [];
          moderateZones = [];
          safeZones = [];

          // High risk zones (red)
          riskZones = [
            L.polygon([
              [26.12, 91.70], [26.12, 91.75], [26.15, 91.75], [26.15, 91.70]
            ], {
              color: "#ef4444", weight: 3, fillColor: "#ef4444", fillOpacity: 0.3,
            }).addTo(map).addTo(authMap).bindPopup("High Risk Zone - Multiple incidents reported"),
            
            L.polygon([
              [26.16, 91.76], [26.16, 91.80], [26.18, 91.80], [26.18, 91.76]
            ], {
              color: "#ef4444", weight: 3, fillColor: "#ef4444", fillOpacity: 0.3,
            }).addTo(map).addTo(authMap).bindPopup("High Risk Zone - Restricted area")
          ];

          // Moderate risk zones (yellow)
          moderateZones = [
            L.circle([26.1445, 91.7362], {
              radius: 2000, color: "#f59e0b", fillColor: "#f59e0b", 
              fillOpacity: 0.2, weight: 2,
            }).addTo(map).addTo(authMap).bindPopup("Moderate Risk Zone - Exercise caution"),
            
            L.circle([26.17, 91.75], {
              radius: 1500, color: "#f59e0b", fillColor: "#f59e0b", 
              fillOpacity: 0.2, weight: 2,
            }).addTo(map).addTo(authMap).bindPopup("Moderate Risk Zone - Limited patrols")
          ];

          // Safe zones (green) around services
          policeStations.forEach((p) => {
            safeZones.push(L.circle([p.pos.lat, p.pos.lng], {
              radius: 800, color: "#22c55e", fillColor: "#22c55e", 
              fillOpacity: 0.15, weight: 1,
            }).addTo(map).addTo(authMap).bindPopup("Safe Zone - Police Station Nearby"));
          });
          
          hospitals.forEach((h) => {
            safeZones.push(L.circle([h.pos.lat, h.pos.lng], {
              radius: 800, color: "#22c55e", fillColor: "#22c55e", 
              fillOpacity: 0.15, weight: 1,
            }).addTo(map).addTo(authMap).bindPopup("Safe Zone - Hospital Nearby"));
          });
        }

        function visualizeUserOnAuthority(p) {
          if (!authMap) return;
          const m = L.circleMarker([p.lat, p.lng], {
            radius: 6,
            fillColor: "#00bcd4",
            fillOpacity: 0.9,
            color: "#fff",
            weight: 1,
          }).addTo(authMap);
          clusterMarkers.push(m);
        }
        function visualizeAnomalyOnAuthority(a) {
          if (!authMap || !a.location) return;
          const [la, ln] = a.location.split(",").map(Number);
          if (isNaN(la) || isNaN(ln)) return;
          const ring = L.circle([la, ln], {
            radius: 400,
            color: "#ef4444",
            fillOpacity: 0.1,
            weight: 2,
          });
          ring.addTo(authMap);
          setTimeout(() => authMap.removeLayer(ring), 10000);
        }
        function generateAuthClusters() {
          const list = $("#cluster-list");
          list.innerHTML = "";
          clusterMarkers.forEach((m) => authMap.removeLayer(m));
          clusterMarkers = [];
          
          if (heatLayer) {
            authMap.removeLayer(heatLayer);
            heatLayer = null;
          }

          const bounds = [[21.0, 88.0], [29.8, 97.5]];
          const pts = [];
          
          // NEW: Get actual tourist data from storage
          const allTourists = JSON.parse(localStorage.getItem("tripguard_tourists") || "[]");
          const currentTouristData = allTourists.find(t => t.id === touristId) || {
            id: touristId,
            position: userMarker ? userMarker.getLatLng() : {lat: 26.1445, lng: 91.7362},
            inRiskZone: false,
            routeDeviation: false
          };

          // Update current tourist data
          if (plannedRoute && userMarker) {
            currentTouristData.plannedRoute = plannedRoute;
            currentTouristData.currentPosition = userMarker.getLatLng();
            currentTouristData.hasActiveRoute = true;
            
            // Check if in risk zone
            riskZones.forEach(zone => {
              if (isInsidePolygon(currentTouristData.currentPosition, zone)) {
                currentTouristData.inRiskZone = true;
              }
            });
          }

          // Save updated tourist data
          const otherTourists = allTourists.filter(t => t.id !== touristId);
          localStorage.setItem("tripguard_tourists", 
            JSON.stringify([...otherTourists, currentTouristData])
          );

          // NEW: Visualize all tourist routes
          visualizeTouristRoutes([currentTouristData, ...otherTourists]);

          // Rest of your existing cluster generation code...
          for (let i = 0; i < 80; i++) {
            const lat = bounds[0][0] + Math.random() * (bounds[1][0] - bounds[0][0]);
            const lng = bounds[0][1] + Math.random() * (bounds[1][1] - bounds[0][1]);
            pts.push([lat, lng, 0.3 + Math.random() * 0.7]);
            
            const m = L.circleMarker([lat, lng], {
              radius: 4,
              fillColor: "#2563eb",
              fillOpacity: 0.8,
              color: "#fff",
              weight: 0.5,
            }).addTo(authMap);
            clusterMarkers.push(m);
          }

          // Add current tourist position
          if (userMarker) {
            const pos = userMarker.getLatLng();
            pts.push([pos.lat, pos.lng, 1.0]);
            
            const currentMarker = L.circleMarker([pos.lat, pos.lng], {
              radius: 8,
              fillColor: "#00bcd4",
              fillOpacity: 0.9,
              color: "#fff",
              weight: 2,
            }).addTo(authMap).bindPopup(`Current Tourist: ${touristId}`);
            clusterMarkers.push(currentMarker);
          }

          activeAlerts.forEach((a) => {
            if (a.location) {
              const [la, ln] = a.location.split(",").map(Number);
              if (!isNaN(la) && !isNaN(ln)) pts.push([la, ln, 1.0]);
            }
          });

          heatLayer = L.heatLayer(pts, { radius: 25, blur: 30, maxZoom: 12 }).addTo(authMap);

          const buckets = { Low: 0, Medium: 0, High: 0 };
          clusterMarkers.forEach(() => {
            const r = Math.random();
            if (r < 0.6) buckets.Low++;
            else if (r < 0.9) buckets.Medium++;
            else buckets.High++;
          });

          Object.entries(buckets).forEach(([risk, count]) => {
            const color = risk === "High" ? "#ef4444" : risk === "Medium" ? "#f59e0b" : "#22c55e";
            const el = document.createElement("div");
            el.className = "cluster-marker";
            el.style.backgroundColor = color;
            el.innerHTML = `<i class="fas fa-users"></i> ${count} tourists (${risk} risk)`;
            list.appendChild(el);
          });
        }

        // NEW: Function to visualize tourist routes on authority map
        function visualizeTouristRoutes(tourists) {
          tourists.forEach(tourist => {
            if (tourist.plannedRoute && tourist.hasActiveRoute) {
              // Draw planned route
              const routeLine = L.polyline(
                tourist.plannedRoute.map(p => [p.lat, p.lng]),
                {
                  color: tourist.id === touristId ? "#3b82f6" : "#8b5cf6",
                  weight: 4,
                  opacity: 0.7,
                  dashArray: tourist.id === touristId ? null : '5, 5'
                }
              ).addTo(authMap).bindPopup(`Tourist ${tourist.id} - Planned Route`);
              
              clusterMarkers.push(routeLine);
              
              // Draw current position if available
              if (tourist.currentPosition) {
                const posMarker = L.circleMarker([
                  tourist.currentPosition.lat, 
                  tourist.currentPosition.lng
                ], {
                  radius: 6,
                  fillColor: tourist.id === touristId ? "#00bcd4" : 
                            tourist.inRiskZone ? "#ef4444" : 
                            tourist.routeDeviation ? "#f59e0b" : "#22c55e",
                  fillOpacity: 0.9,
                  color: "#fff",
                  weight: 2
                }).addTo(authMap).bindPopup(`
                  Tourist: ${tourist.id}<br>
                  Status: ${tourist.inRiskZone ? 'In Risk Zone' : 
                          tourist.routeDeviation ? 'Route Deviation' : 'Safe'}<br>
                  ${tourist.hasActiveRoute ? 'Has active route' : 'No active route'}
                `);
                
                clusterMarkers.push(posMarker);
              }
            }
          });
        }

        // Auth
        window.login = function () {
          const role = document.getElementById('role-select').value;
          const email = $("#email").value;
          const password = $("#password").value;
          
          // Debug: check what values we're getting
          console.log("Email:", email);
          console.log("Password:", password);
          console.log("Password length:", password.length);
          
          if (!email || !password) {
              alert("Please enter both email and password\nEmail: " + email + "\nPassword: " + password);
              return;
          }
          if (role === 'tourist') {
            const idType = (document.getElementById('id-type').value || 'aadhar');
            if (idType === 'aadhar') {
              const aadhar = (document.getElementById('aadhar').value || '').trim();
              if (!/^\d{12}$/.test(aadhar)) { alert('Enter valid 12-digit Aadhar'); return; }
              currentUser = { email, name: email.split("@")[0], type: "tourist", identityType: 'aadhar', aadhar };
              touristId = `TOUR-${aadhar.slice(-6)}-${uuidv4().slice(0,4).toUpperCase()}`;
            } else {
              const passportRaw = (document.getElementById('passport').value || '').trim().toUpperCase();
              if (!/^[A-Z][0-9]{7}$/.test(passportRaw)) { alert('Enter valid Passport (e.g., A1234567)'); return; }
              currentUser = { email, name: email.split("@")[0], type: "tourist", identityType: 'passport', passport: passportRaw };
              const suffix = passportRaw.slice(-4);
              touristId = `TOUR-${suffix}-${uuidv4().slice(0,4).toUpperCase()}`;
            }
            $("#login-screen").classList.add("hidden");
            $("#app-container").classList.remove("hidden");
            $("#user-info").textContent = currentUser.email;
            $("#tourist-name").textContent = currentUser.name;
            $("#tourist-id").textContent = "ID: " + touristId;
            $("#safety-score").textContent = safetyScore;
            $("#header-safety").textContent = "Safety Score: " + safetyScore;
            initMaps();
            startTracking();
            if ("Notification" in window && Notification.permission === "default") {
              Notification.requestPermission();
            }
          } else {
            const authId = (document.getElementById('authority-id').value || '').trim();
            if (!authId) { alert('Enter Authority ID'); return; }
            currentUser = { email, name: `Authority ${authId}`, type: "authority", authId };
            $("#login-screen").classList.add("hidden");
            $("#app-container").classList.remove("hidden");
            $("#user-info").textContent = currentUser.email;
            // Default to authority dashboard after login
            switchTab(null, 'authority');
            initMaps();
          }
        };
        window.register = function () {
          const email = $("#email").value,
            password = $("#password").value;
          if (!email || !password) {
            alert("Please enter both email and password");
            return;
          }
          alert("Registration successful! You can now login.");
        };
        window.loginAsAuthority = function () {
          const roleSel = document.getElementById('role-select');
          const t = document.getElementById('tourist-kyc');
          const a = document.getElementById('authority-fields');
          roleSel.value = 'authority'; t.style.display = 'none'; a.style.display = 'block';
        };
        window.logout = function () {
          if (trackingWatchId)
            navigator.geolocation.clearWatch(trackingWatchId);
          if (familyInterval) clearInterval(familyInterval);
          if (inactivityTimer) clearInterval(inactivityTimer);
          currentUser = null;
          touristId = null;
          $("#app-container").classList.add("hidden");
          $("#login-screen").classList.remove("hidden");
        };

        // Geolocation watch
        function startTracking() {
          if (!navigator.geolocation) {
            alert("Geolocation not supported");
            return;
          }
          trackingWatchId = navigator.geolocation.watchPosition(
            (p) => {
              const pos = { lat: p.coords.latitude, lng: p.coords.longitude };
              updateUserLocationUI(pos);
            },
            handleGeoError,
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 },
          );
          startInactivityMonitoring();
        }
        function updateUserLocationUI(pos) {
          const ll = [pos.lat, pos.lng];
          if (userMarker) userMarker.setLatLng(ll);
          if (map) map.setView(ll);
          checkGeofence(pos);
          if (plannedRoute) checkRouteDeviation(pos);
          resetInactivityTimer();
          
          // Update tourist position in storage
          updateTouristStatus(touristId, { 
            position: pos,
            lastUpdate: new Date().toISOString()
          });
          
          // Update authority map if it exists
          if (authMap) {
            generateAuthClusters(); // Refresh clusters with updated positions
          }
        }

        // Geofence (polygon)
        function pointInPolygon(point, vs) {
          // ray-casting
          const x = point.lng,
            y = point.lat;
          let inside = false;
          for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
            const xi = vs[i][1],
              yi = vs[i][0];
            const xj = vs[j][1],
              yj = vs[j][0];
            const intersect =
              yi > y != yj > y && x < ((xj - xi) * (y - yi)) / (yj - yi) + xi;
            if (intersect) inside = !inside;
          }
          return inside;
        }
        function isInsideCircle(p, circle) {
          const c = circle.getLatLng();
          const r = circle.getRadius();
          return haversine(p, { lat: c.lat, lng: c.lng }) <= r;
        }
        function isInsidePolygon(p, poly) {
          const coords = poly.getLatLngs()[0].map((ll) => [ll.lat, ll.lng]);
          return pointInPolygon(p, coords);
        }
        function inAny(layers, p) {
          for (const l of layers) {
            if (l.getRadius) {
              if (isInsideCircle(p, l)) return true;
            } else if (l.getLatLngs) {
              if (isInsidePolygon(p, l)) return true;
            }
          }
          return false;
        }
        function centroidOfPolygon(poly) {
          const pts = poly.getLatLngs()[0];
          let lat = 0,
            lng = 0;
          pts.forEach((pt) => {
            lat += pt.lat;
            lng += pt.lng;
          });
          return { lat: lat / pts.length, lng: lng / pts.length };
        }
        function checkGeofence(p) {
          if (inAny(riskZones, p)) {
            const a = {
              id: uuidv4(),
              touristId,
              name: currentUser?.name,
              type: "Entered Risk Zone",
              location: `${p.lat.toFixed(6)},${p.lng.toFixed(6)}`,
              time: new Date().toLocaleString(),
              priority: "High",
            };
            addAlert(a);
            speak(ttsKey("enteredRisk"));
            notify("You entered a high-risk zone");
            return;
          }
          if (inAny(moderateZones, p)) {
            const a = {
              id: uuidv4(),
              touristId,
              name: currentUser?.name,
              type: "Entered Moderate Zone",
              location: `${p.lat.toFixed(6)},${p.lng.toFixed(6)}`,
              time: new Date().toLocaleString(),
              priority: "Low",
            };
            addAlert(a);
          }
        }

        // Route planning using Nominatim geocoding + straight-line polyline (demo)
        async function geocode(q) {
          if (q === "current" && userMarker) {
            const ll = userMarker.getLatLng();
            return { lat: ll.lat, lng: ll.lng };
          }
          const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
          const r = await fetch(url, {
            headers: { "Accept-Language": uiLanguage },
          });
          const j = await r.json();
          if (!j[0]) throw new Error("Location not found: " + q);
          return { lat: parseFloat(j[0].lat), lng: parseFloat(j[0].lon) };
        }
        async function osrmRoute(a, b) {
          const url = `https://router.project-osrm.org/route/v1/foot/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
          const r = await fetch(url);
          const j = await r.json();
          if (j.code !== "Ok") throw new Error("Routing failed");
          const coords = j.routes[0].geometry.coordinates.map(([lng, lat]) => ({
            lat,
            lng,
          }));
          return coords;
        }
        async function routeVia(points) {
          let all = [];
          for (let i = 0; i < points.length - 1; i++) {
            const seg = await osrmRoute(points[i], points[i + 1]);
            if (i > 0) seg.shift();
            all = all.concat(seg);
          }
          return all;
        }
        window.openRoutePlanner = async function () {
          try {
            const origin = prompt('Enter origin address or "current"', "current");
            if (!origin) return;
            const dest = prompt("Enter destination address", "Shillong");
            if (!dest) return;
            const stopsRaw = prompt("Intermediate stops (semicolon separated, optional)", "");
            const stops = (stopsRaw || "").split(";").map((s) => s.trim()).filter(Boolean);
            
            const points = [await geocode(origin)];
            for (const s of stops) {
              points.push(await geocode(s));
            }
            points.push(await geocode(dest));
            
            const basePath = await routeVia(points);
            const detouredPoints = buildSafeDetour(points);
            const detourPath = await routeVia(detouredPoints);
            const baseScore = computeSafetyScore(basePath);
            const detourScore = computeSafetyScore(detourPath);
            const bestPath = detourScore > baseScore ? detourPath : basePath;
            
            plannedRoute = bestPath;
            drawSafeRoute(bestPath);
            
            const bestScore = detourScore > baseScore ? detourScore : baseScore;
            safetyScore = bestScore;
            $("#safety-score").textContent = bestScore;
            $("#header-safety").textContent = "Safety Score: " + bestScore;
            
            // NEW: Store route for authority monitoring
            updateTouristStatus(touristId, {
              plannedRoute: bestPath,
              currentPosition: userMarker ? userMarker.getLatLng() : points[0],
              hasActiveRoute: true,
              routeSafetyScore: bestScore
            });
            
            showNearestServicesAlongRoute(bestPath);
            
            // NEW: Refresh authority map to show the new route
            if (authMap) {
              setTimeout(() => generateAuthClusters(), 500);
            }
            
          } catch (e) {
            alert("Route error: " + e.message);
          }
        };
        function buildSafeDetour(path) {
          let out = [...path];
          for (const poly of riskZones) {
            const c = centroidOfPolygon(poly); // if line passes near this polygon bbox, insert nearest service as waypoint
            const nearPolice = policeStations.reduce((p, cur) =>
              haversine(c, cur.pos) < haversine(c, p.pos) ? cur : p,
            );
            const nearHospital = hospitals.reduce((p, cur) =>
              haversine(c, cur.pos) < haversine(c, p.pos) ? cur : p,
            );
            const via =
              haversine(path[Math.floor(path.length / 2)], nearPolice.pos) <
              haversine(path[Math.floor(path.length / 2)], nearHospital.pos)
                ? nearPolice.pos
                : nearHospital.pos;
            // insert waypoint in the middle
            const mid = Math.floor(out.length / 2);
            out = [...out.slice(0, mid), via, ...out.slice(mid)];
          }
          return out;
        }
        function drawSafeRoute(path) {
          if (safePolyline) {
            map.removeLayer(safePolyline);
          }
          
          // Draw the safe route
          safePolyline = L.polyline(
            path.map((p) => [p.lat, p.lng]),
            { 
              color: "#22c55e", 
              weight: 6,
              opacity: 0.8
            }
          ).addTo(map);
          
          // NEW: Highlight risk zones along the route
          highlightRiskZonesAlongRoute(path);
          
          map.fitBounds(safePolyline.getBounds(), { padding: [30, 30] });
        }

        // NEW: Function to highlight risk zones along the route
        function highlightRiskZonesAlongRoute(path) {
          // Clear previous highlights
          const existingHighlights = document.querySelectorAll('.route-risk-highlight');
          existingHighlights.forEach(highlight => map.removeLayer(highlight));
          
          path.forEach((point, index) => {
            riskZones.forEach(zone => {
              if (isInsidePolygon(point, zone)) {
                // Add a warning marker at risk points
                L.circleMarker([point.lat, point.lng], {
                  radius: 8,
                  color: "#ef4444",
                  fillColor: "#ef4444",
                  fillOpacity: 0.7,
                  weight: 2
                })
                .addTo(map)
                .bindPopup(`⚠️ High Risk Zone\nRoute point ${index + 1}`)
                ._path.classList.add('route-risk-highlight');
              }
            });
          });
        }

        function computeSafetyScore(path) {
          let score = 100; // penalties and bonuses along path
          // risk/moderate
          for (const p of path) {
            if (inAny(riskZones, p)) {
              score -= 40;
              break;
            }
          }
          for (const p of path) {
            if (inAny(moderateZones, p)) {
              score -= 12;
              break;
            }
          }
          // proximity to services
          let total = 0,
            c = 0,
            safeHits = 0;
          for (const p of path.slice(0, Math.min(30, path.length))) {
            const pd = Math.min(
              ...policeStations.map((ps) => haversine(p, ps.pos)),
            );
            const hd = Math.min(...hospitals.map((h) => haversine(p, h.pos)));
            const d = Math.min(pd, hd);
            total += d;
            c++;
            if (inAny(safeZones, p)) safeHits++;
          }
          const avg = c ? total / c : 0;
          if (avg > 1500) score -= 25;
          else score -= Math.round((avg / 1500) * 15);
          // bonus if within safe zones for many points
          if (safeHits >= c / 3) score += 10;
          return Math.max(20, Math.min(100, Math.round(score)));
        }
        function haversine(a, b) {
          const R = 6371000;
          const toRad = Math.PI / 180;
          const dLat = (a.lat - b.lat) * toRad,
            dLon = (a.lng - b.lng) * toRad;
          const la = a.lat * toRad,
            lb = b.lat * toRad;
          const sa =
            Math.sin(dLat / 2) ** 2 +
            Math.cos(la) * Math.cos(lb) * Math.sin(dLon / 2) ** 2;
          const c = 2 * Math.atan2(Math.sqrt(sa), Math.sqrt(1 - sa));
          return R * c;
        }
        function showNearestServicesAlongRoute(path) {
          if (!path.length) return;
          const step = Math.max(1, Math.floor(path.length / 10));
          const sample = path.filter((_, i) => i % step === 0);
          const seen = new Set();
          sample.forEach((pt) => {
            const key =
              Math.round(pt.lat * 1000) + "," + Math.round(pt.lng * 1000);
            if (seen.has(key)) return;
            seen.add(key);
            const np = policeStations.reduce((p, c) =>
              haversine(pt, c.pos) < haversine(pt, p.pos) ? c : p,
            );
            const nh = hospitals.reduce((p, c) =>
              haversine(pt, c.pos) < haversine(pt, p.pos) ? c : p,
            );
            L.circleMarker([np.pos.lat, np.pos.lng], {
              radius: 6,
              color: "#332",
              fillColor: "#ffcc00",
              fillOpacity: 1,
            }).addTo(map);
            L.circleMarker([nh.pos.lat, nh.pos.lng], {
              radius: 6,
              color: "#143",
              fillColor: "#22c55e",
              fillOpacity: 1,
            }).addTo(map);
          });
        }

        // Deviation + inactivity
        function pointToSegmentDistance(point, A, B) {
          const a = point.lat - A.lat,
            b = point.lng - A.lng,
            c = B.lat - A.lat,
            d = B.lng - A.lng;
          const dot = a * c + b * d,
            len = c * c + d * d;
          let param = len !== 0 ? dot / len : -1;
          let xx, yy;
          if (param < 0) {
            xx = A.lat;
            yy = A.lng;
          } else if (param > 1) {
            xx = B.lat;
            yy = B.lng;
          } else {
            xx = A.lat + param * c;
            yy = A.lng + param * d;
          }
          const dx = point.lat - xx,
            dy = point.lng - yy;
          return Math.sqrt(dx * dx + dy * dy) * 111320;
        }
        function checkRouteDeviation(p) {
          if (!plannedRoute || plannedRoute.length < 2) return;
          let min = Infinity;
          for (let i = 0; i < plannedRoute.length - 1; i++) {
            const d = pointToSegmentDistance(
              p,
              plannedRoute[i],
              plannedRoute[i + 1],
            );
            if (d < min) min = d;
          }
          if (min > 80) {
            const a = {
              id: uuidv4(),
              touristId,
              name: currentUser.name,
              type: "Route Deviation",
              location: `${p.lat.toFixed(6)},${p.lng.toFixed(6)}`,
              time: new Date().toLocaleString(),
              priority: "Medium",
            };
            addAlert(a);
            visualizeAnomalyOnAuthority(a);
            speak(ttsKey("offRoute"));
            notify("You have deviated from your planned route");
          }
        }

        function startInactivityMonitoring() {
          inactivityTimer = setInterval(() => {
            if (!userMarker) return;
            const cur = userMarker.getLatLng();
            if (lastPosition && cur) {
              const dist = haversine(
                { lat: lastPosition.lat, lng: lastPosition.lng },
                { lat: cur.lat, lng: cur.lng },
              );
              if (dist < 10) {
                if (!stationaryStartTime) {
                  stationaryStartTime = new Date();
                } else {
                  const secs = (new Date() - stationaryStartTime) / 1000;
                  if (secs > 120) {
                    const a = {
                      id: uuidv4(),
                      touristId,
                      name: currentUser.name,
                      type: "Inactivity Alert",
                      location: `${cur.lat.toFixed(6)},${cur.lng.toFixed(6)}`,
                      time: new Date().toLocaleString(),
                      priority: "Medium",
                    };
                    addAlert(a);
                    visualizeAnomalyOnAuthority(a);
                    speak(ttsKey("stillness"));
                    notify("You have been stationary for a while");
                    stationaryStartTime = null;
                  }
                }
              } else {
                stationaryStartTime = null;
              }
              lastPosition = cur;
            } else {
              lastPosition = cur;
            }
          }, 30000);
        }
        function resetInactivityTimer() {
          if (!userMarker) return;
          lastPosition = userMarker.getLatLng();
          stationaryStartTime = null;
        }

        // Family tracking toggle
        window.toggleFamilyTracking = function () {
          const btn = $("#btn-family");
          if (familyInterval) {
            clearInterval(familyInterval);
            familyInterval = null;
            if (map.hasLayer(familyMarker)) map.removeLayer(familyMarker);
            btn.textContent = "Start Family Tracking";
            alert("Family tracking stopped.");
            return;
          }
          const center = userMarker?.getLatLng?.();
          if (!center) {
            alert("Start location first");
            return;
          }
          if (!map.hasLayer(familyMarker)) familyMarker.addTo(map);
          familyInterval = setInterval(() => {
            const offLat = (Math.random() - 0.5) * 0.01,
              offLng = (Math.random() - 0.5) * 0.01;
            const np = { lat: center.lat + offLat, lng: center.lng + offLng };
            familyMarker.setLatLng([np.lat, np.lng]);
          }, 5000);
          btn.textContent = "Stop Family Tracking";
          alert("Family tracking started.");
        };

        // Panic & share
        window.triggerPanicAlert = function () {
          const pos = userMarker?.getLatLng?.();
          if (!pos) {
            alert("Location not available");
            return;
          }
          const nearPolice = policeStations.reduce((p, c) =>
            haversine({ lat: pos.lat, lng: pos.lng }, c.pos) <
            haversine({ lat: pos.lat, lng: pos.lng }, p.pos)
              ? c
              : p,
          );
          const a = {
            id: uuidv4(),
            touristId,
            name: currentUser.name,
            type: "Panic",
            location: `${pos.lat.toFixed(6)},${pos.lng.toFixed(6)}`,
            time: new Date().toLocaleString(),
            priority: "Critical",
          };
          addAlert(a);
          visualizeAnomalyOnAuthority(a);
          document.body.style.backgroundColor = "#ff0000";
          setTimeout(() => (document.body.style.backgroundColor = ""), 300);
          speak("Panic alert activated! Help is on the way.");
          notify("🚨 PANIC ALERT ACTIVATED!");
          alert(`Nearest authority: ${nearPolice.name}\nContact: ${nearPolice.phone || '100'}\nAlert recorded and routed.`);
        };
        window.shareLocation = function () {
          const pos = userMarker?.getLatLng?.();
          if (pos) {
            const url = `https://maps.google.com/?q=${pos.lat},${pos.lng}`;
            const text = encodeURIComponent(
              "My TripGuard live location: " + url,
            );
            const wa = `https://wa.me/?text=${text}`;
            const sms = `sms:?&body=${text}`;
            window.open(wa, "_blank");
            setTimeout(() => window.open(sms, "_blank"), 500);
          } else {
            alert("Location not available");
          }
        };

        // Voice
        window.startVoiceControl = function () {
          const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
          if (!SR) {
            alert("Speech recognition not supported");
            return;
          }
          speechRec = new SR();
          speechRec.continuous = true;
          speechRec.interimResults = true;
          speechRec.lang = uiLanguage;
          speechRec.onresult = (e) => {
            for (let i = e.resultIndex; i < e.results.length; i++) {
              if (e.results[i].isFinal) {
                const t = e.results[i][0].transcript.toLowerCase();
                if (t.includes("panic")) {
                  triggerPanicAlert();
                  speechRec.stop();
                }
              }
            }
          };
          speechRec.start();
          alert("Voice control activated. Say 'panic'.");
        };

        // Feedback
        window.setRating = function (r) {
          ratingValue = r;
          for (let i = 1; i <= 5; i++) {
            document.getElementById("star" + i).style.color =
              i <= r ? "#f59e0b" : "#ccc";
          }
        };
        window.submitFeedback = function () {
          const text = $("#feedback-input").value.trim();
          if (!text) {
            alert("Please enter your feedback");
            return;
          }
          const fb = {
            id: uuidv4(),
            touristId,
            name: currentUser?.name || "Tourist",
            rating: ratingValue || 5,
            text,
            time: new Date().toLocaleString(),
          };
          feedbackList.unshift(fb);
          saveFeedbackList();
          alert("Thank you for your feedback!");
          $("#feedback-input").value = "";
          setRating(0);
        };
        window.viewFeedback = function () {
          alert("Total feedback entries: " + feedbackList.length);
        };

        window.showItinerary = function () {
          if (!plannedRoute || !plannedRoute.length) {
            alert("No itinerary yet. Use Route Planner.");
            return;
          }
          let total = 0;
          for (let i = 0; i < plannedRoute.length - 1; i++) {
            total += haversine(plannedRoute[i], plannedRoute[i + 1]);
          }
          const lines = plannedRoute
            .map((p, i) => `${i + 1}. ${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}`)
            .join("\n");
          alert(
            `Itinerary (stops: ${plannedRoute.length})\nTotal distance: ${(total / 1000).toFixed(1)} km\n\n${lines}`,
          );
        };

        // Alerts list
        function renderAlerts() {
          const list = $("#alerts-list");
          list.innerHTML = "";
          
          // Filter active alerts
          const activeAlertsList = activeAlerts.filter(alert => 
            !alert.resolved || alert.priority === "Critical"
          );
          
          $("#authority-alert-count").textContent = activeAlertsList.length;
          $("#alert-count-display").textContent = activeAlertsList.length + " Active Alerts";
          $("#authority-count").textContent = activeAlertsList.length;

          if (activeAlertsList.length === 0) {
            list.innerHTML = '<div class="muted" style="text-align: center; padding: 20px;">No active alerts</div>';
            return;
          }

          activeAlertsList.forEach((a) => {
            const el = document.createElement("div");
            el.className = "alert-item";
            
            // Add different styles based on priority
            if (a.priority === "Critical") {
              el.style.borderLeftColor = "#ef4444";
              el.style.background = "#fff0f0";
            } else if (a.priority === "High") {
              el.style.borderLeftColor = "#f59e0b";
              el.style.background = "#fffbf0";
            } else {
              el.style.borderLeftColor = "#22c55e";
              el.style.background = "#f0fff4";
            }
            
            el.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                  <strong>${a.type}</strong> 
                  <span class="muted">- ${a.name || a.touristId}</span>
                  <div class="muted" style="font-size: 12px; margin-top: 4px;">
                    Location: ${a.location || "-"} | Time: ${a.time}
                  </div>
                  ${a.message ? `<div style="margin-top: 6px; font-size: 13px;">${a.message}</div>` : ''}
                </div>
                <div style="display: flex; gap: 5px;">
                  <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="resolveAlert('${a.id}')">Resolve</button>
                  <button class="btn btn-outline" style="padding: 4px 8px; font-size: 12px;" onclick="viewAlertOnMap('${a.id}')">View</button>
                </div>
              </div>
            `;
            list.appendChild(el);
          });
        }

        // New function to resolve alerts
        function resolveAlert(alertId) {
          const alertIndex = activeAlerts.findIndex(a => a.id === alertId);
          if (alertIndex !== -1) {
            activeAlerts[alertIndex].resolved = true;
            activeAlerts[alertIndex].resolvedTime = new Date().toLocaleString();
            saveAlerts();
          }
        }

        // New function to view alert on map
        function viewAlertOnMap(alertId) {
          const alert = activeAlerts.find(a => a.id === alertId);
          if (alert && alert.location) {
            const [lat, lng] = alert.location.split(',').map(Number);
            if (!isNaN(lat) && !isNaN(lng)) {
              authMap.setView([lat, lng], 15);
              
              // Highlight the location with a pulsing circle
              const circle = L.circle([lat, lng], {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.3,
                radius: 200
              }).addTo(authMap);
              
              setTimeout(() => {
                authMap.removeLayer(circle);
              }, 5000);
            }
          }
        }

        // Enhanced function to check route deviation with authority notification
        function checkRouteDeviation(p) {
          if (!plannedRoute || plannedRoute.length < 2) return;
          
          let min = Infinity;
          for (let i = 0; i < plannedRoute.length - 1; i++) {
            const d = pointToSegmentDistance(p, plannedRoute[i], plannedRoute[i + 1]);
            if (d < min) min = d;
          }
          
          if (min > 80) { // Deviation threshold: 80 meters
            const a = {
              id: uuidv4(),
              touristId,
              name: currentUser.name,
              type: "Route Deviation",
              message: `Tourist deviated ${Math.round(min)}m from planned route`,
              location: `${p.lat.toFixed(6)},${p.lng.toFixed(6)}`,
              time: new Date().toLocaleString(),
              priority: "High",
            };
            addAlert(a);
            
            // Visualize on authority map
            visualizeAnomalyOnAuthority(a);
            
            // Update tourist in storage
            updateTouristStatus(touristId, { routeDeviation: true, lastPosition: p });
          }
        }

        // Function to update tourist status in storage
        function updateTouristStatus(touristId, updates) {
          const allTourists = JSON.parse(localStorage.getItem("tripguard_tourists") || "[]");
          const touristIndex = allTourists.findIndex(t => t.id === touristId);
          
          if (touristIndex !== -1) {
            allTourists[touristIndex] = { ...allTourists[touristIndex], ...updates };
          } else {
            allTourists.push({ id: touristId, ...updates });
          }
          
          localStorage.setItem("tripguard_tourists", JSON.stringify(allTourists));
        }

        // Enhanced visualizeAnomalyOnAuthority function
        function visualizeAnomalyOnAuthority(a) {
          if (!authMap || !a.location) return;
          const [la, ln] = a.location.split(",").map(Number);
          if (isNaN(la) || isNaN(ln)) return;
          
          // Create a pulsating circle for the anomaly
          const circle = L.circle([la, ln], {
            radius: 300,
            color: "#ef4444",
            fillColor: "#ef4444",
            fillOpacity: 0.2,
            weight: 2,
          }).addTo(authMap);
          
          // Add popup with alert details
          circle.bindPopup(`
            <strong>${a.type} Alert</strong><br>
            Tourist: ${a.name || a.touristId}<br>
            Time: ${a.time}<br>
            ${a.message || ''}
          `).openPopup();
          
          // Remove after 10 seconds
          setTimeout(() => {
            authMap.removeLayer(circle);
          }, 10000);
        }

        // EFIR
        window.generateEFIR = function () {
          const name = $("#efir-name").value,
            id = $("#efir-id").value,
            loc = $("#efir-location").value,
            details = $("#efir-details").value;
          if (!name || !id || !loc || !details) {
            alert("Please fill all fields");
            return;
          }
          const content = `ELECTRONIC FIRST INFORMATION REPORT (E-FIR)\n==========================================\n\nTourist Name: ${name}\nTourist ID: ${id}\nIncident Location: ${loc}\nReport Time: ${new Date().toLocaleString()}\n\nIncident Details:\n${details}\n\nThis is a simulated E-FIR for demonstration purposes only.`;
          const blob = new Blob([content], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `EFIR-${id}-${Date.now()}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          alert("E-FIR generated and downloaded");
        };

        // Simulations
        window.simulateDeviation = function () {
          const log = $("#analytics-log");
          log.innerHTML =
            '<div class="alert-item">Simulating route deviation...</div>' +
            log.innerHTML;
          const pos = userMarker?.getLatLng?.();
          if (pos) {
            const a = {
              id: uuidv4(),
              touristId,
              name: currentUser?.name,
              type: "Simulated Deviation",
              location: `${pos.lat.toFixed(6)},${pos.lng.toFixed(6)}`,
              time: new Date().toLocaleString(),
              priority: "Medium",
            };
            addAlert(a);
          }
        };
        window.simulateDropoff = function () {
          const log = $("#analytics-log");
          log.innerHTML =
            '<div class="alert-item">Simulating sudden drop-off...</div>' +
            log.innerHTML;
          const pos = userMarker?.getLatLng?.();
          if (pos) {
            const a = {
              id: uuidv4(),
              touristId,
              name: currentUser?.name,
              type: "Simulated Drop-off",
              location: `${pos.lat.toFixed(6)},${pos.lng.toFixed(6)}`,
              time: new Date().toLocaleString(),
              priority: "High",
            };
            addAlert(a);
          }
        };
        window.simulateInactivity = function () {
          const log = $("#analytics-log");
          log.innerHTML =
            '<div class="alert-item">Simulating prolonged inactivity...</div>' +
            log.innerHTML;
          const pos = userMarker?.getLatLng?.();
          if (pos) {
            const a = {
              id: uuidv4(),
              touristId,
              name: currentUser?.name,
              type: "Simulated Inactivity",
              location: `${pos.lat.toFixed(6)},${pos.lng.toFixed(6)}`,
              time: new Date().toLocaleString(),
              priority: "Medium",
            };
            addAlert(a);
          }
        };

        // UI Nav
        window.switchTab = function (event, tabName) {
          document
            .querySelectorAll(".tab-btn")
            .forEach((b) => b.classList.remove("active"));
          if (event) {
            event.currentTarget.classList.add("active");
          } else {
            document
              .querySelector(`[data-tab="${tabName}"]`)
              .classList.add("active");
          }
          document
            .querySelectorAll(".tab-pane")
            .forEach((p) => p.classList.remove("active"));
          document.getElementById(tabName + "-tab").classList.add("active");
        };
        window.switchAuthorityTab = function (event, tabName) {
          document
            .querySelectorAll(".sidebar-item")
            .forEach((i) => i.classList.remove("active"));
          event.currentTarget.classList.add("active");
          $("#efir-card").style.display = tabName === "efir" ? "block" : "none";
        };

        // Toggle form sections based on role
        (function(){
          const roleSel = document.getElementById('role-select');
          const touristKyc = document.getElementById('tourist-kyc');
          const authFields = document.getElementById('authority-fields');
          const idTypeSel = document.getElementById('id-type');
          const kycAadhar = document.getElementById('kyc-aadhar');
          const kycPassport = document.getElementById('kyc-passport');
          function syncRole(){
            if(roleSel.value === 'authority'){ touristKyc.style.display='none'; authFields.style.display='block'; }
            else { touristKyc.style.display='block'; authFields.style.display='none'; }
          }
          function syncId(){
            if((idTypeSel?.value||'aadhar') === 'passport'){ kycAadhar.style.display='none'; kycPassport.style.display='block'; }
            else { kycAadhar.style.display='block'; kycPassport.style.display='none'; }
          }
          roleSel.addEventListener('change', syncRole);
          idTypeSel?.addEventListener('change', syncId);
          syncRole(); syncId();
        })();

        document
          .getElementById("language-select")
          .addEventListener("change", function () {
            uiLanguage = this.value;
            applyLanguage();
          });

        const I18N = {
          en: {
            tourist_interface: "Tourist Interface",
            authority_dashboard: "Authority Dashboard",
            analytics: "Analytics",
            login: "Login",
            register: "Register",
            authority_login: "Authority Login",
            route_planner: "Route Planner",
            start_family: "Start Family Tracking",
            share_location: "Share Location",
            my_itinerary: "My Itinerary",
            panic: "Panic",
            voice_control: "Start Voice Control (say 'panic')",
            active_alerts: "Active Alerts",
          },
          hi: {
            tourist_interface: "पर्यटक इंटरफ़ेस",
            authority_dashboard: "प्राधिकरण डैशबोर्ड",
            analytics: "विश्लेषण",
            login: "लॉगिन",
            register: "रजिस्टर",
            authority_login: "प्राधिकरण लॉगिन",
            route_planner: "रूट प्लानर",
            start_family: "परिवार ट्रैकिंग शुरू करें",
            share_location: "स्थान साझा करें",
            my_itinerary: "मेरी यात्रा योजना",
            panic: "पैनिक",
            voice_control: "वॉइस कंट्रोल शुरू करें (कहें 'panic')",
            active_alerts: "सक्रिय अलर्ट",
          },
          bn: {
            tourist_interface: "पर्यটক ইন্টারফেস",
            authority_dashboard: "কর্তৃপক্ষ ড্যাশবোর্ড",
            analytics: "বিশ্লেষণ",
            login: "লগইন",
            register: "রেজিস্টার",
            authority_login: "কর্তৃপক্ষ লগইন",
            route_planner: "রুট পরিকল্পনা",
            start_family: "পরিবার ট্র্যাকিং শুরু",
            share_location: "অবস্থান শেয়ার করুন",
            my_itinerary: "আমার ভ্রমণসূচি",
            panic: "প্যানিক",
            voice_control: "ভয়েস কন্ট্রোল শুরু করুন ('panic' বলুন)",
            active_alerts: "সক্রিয় সতর্কতা",
          },
          mr: {
            tourist_interface: "पर्यटक इंटरफेस",
            authority_dashboard: "अधिकार्‍यांचा डॅशबोर्ड",
            analytics: "विश्‍लेषण",
            login: "लॉगिन",
            register: "नोंदणी",
            authority_login: "अधिकार्‍यांचे लॉगिन",
            route_planner: "मार्ग नियोजक",
            start_family: "कुटुंब ट्रॅकिंग सुरू",
            share_location: "स्थान शेअर करा",
            my_itinerary: "माझी यात्रा",
            panic: "पॅनिक",
            voice_control: "व्हॉईस कंट्रोल सुरू करा ('panic' म्हणा)",
            active_alerts: "सक्रिय अलर्ट",
          },
          te: {
            tourist_interface: "టూరిస్టు ఇంటర్‌ఫేస్",
            authority_dashboard: "అథారిటీ డ్యాష్‌బోర్డ్",
            analytics: "విశ్లేషణ",
            login: "లాగిన్",
            register: "నమోదు",
            authority_login: "అథారిటీ లాగిన్",
            route_planner: "రూట్ ప్లానర్",
            start_family: "ఫ్యామిలీ ట్రాకింగ్ ప్రారంభించండి",
            share_location: "లోకేషన్ పంచుకోండి",
            my_itinerary: "నా ప్రయాణ ప్రణాళిక",
            panic: "పానిక్",
            voice_control: "వాయిస్ నియంత్రణ ప్రారంభించండి ('panic' అనండి)",
            active_alerts: "క్రియాశీల అలెర్ట్లు",
          },
          ta: {
            tourist_interface: "சுற்றுலா இடைமுகம்",
            authority_dashboard: "அதிகார பலகை",
            analytics: "ஆய்வுகள்",
            login: "உள்நுழைக",
            register: "பதிவு",
            authority_login: "அதிகாரி உள்நுழைவு",
            route_planner: "பாதை திட்டமிடல்",
            start_family: "குடும்ப கண்காணிப்பு தொடங்கு",
            share_location: "இருப்பிடம் பகிரவும்",
            my_itinerary: "என் பயண திட்டம்",
            panic: "பீதி",
            voice_control: "குரல் கட்டுப்பாட்டை தொடங்கு ('panic' சொல்)",
            active_alerts: "செயலில் எச்சரிக்கைகள்",
          },
          kn: {
            tourist_interface: "ಪ್ರವಾಸಿ ಇಂಟರ್ಫೇಸ್",
            authority_dashboard: "ಅಧಿಕಾರಿ ಡ್ಯಾಶ್‌ಬೋರ್ಡ್",
            analytics: "ವಿಶ್ಲೇಷಣೆ",
            login: "ಲಾಗಿನ್",
            register: "ನೋಂದಣಿ",
            authority_login: "ಅಧಿಕಾರಿ ಲಾಗಿನ್",
            route_planner: "ಮಾರ್ಗ ಯೋಜಕ",
            start_family: "ಕುಟುಂಬ ಟ್ರ್ಯಾಕಿಂಗ್ ಪ್ರಾರಂಭಿಸಿ",
            share_location: "ಸ್ಥಳ ಹಂಚಿಕೆ",
            my_itinerary: "ನನ್ನ ಪ್ರಯಾಣ ಯೋಜನೆ",
            panic: "ಗಾಬರಿ",
            voice_control: "ವಾಯ್ಸ್ ನಿಯಂತ್ರಣ ಪ್ರಾರಂಭಿಸಿ ('panic' ಎಂದು ಹೇಳಿ)",
            active_alerts: "ಸಕ್ರಿಯ ಎಚ್ಚರಿಕೆಗಳು",
          },
          ml: {
            tourist_interface: "സഞ്ചാരി ഇന്റർഫേസ്",
            authority_dashboard: "അധികാരി ഡാഷ്ബോർഡ്",
            analytics: "വിശകലനം",
            login: "ലോഗിൻ",
            register: "രജിസ്റ്റർ",
            authority_login: "അധികാരി ലോഗിൻ",
            route_planner: "റൂട്ട് പ്ലാനർ",
            start_family: "കുടുംബ ട്രാക്കിംഗ് ആരംഭിക്കുക",
            share_location: "ലൊക്കേഷൻ പങ്കിടുക",
            my_itinerary: "എന്റെ യാത്ര",
            panic: "പാനിക്",
            voice_control: "വോയ്സ് നിയന്ത്രണം ആരംഭിക്കുക ('panic' പറയുക)",
            active_alerts: "സജീവ അലർട്ടുകൾ",
          },
          gu: {
            tourist_interface: "પર્યટક ઇન્ટરફેસ",
            authority_dashboard: "સત્તાવાળાનો ડૅશબોર્ડ",
            analytics: "વિશ્લેષણ",
            login: "લૉગિન",
            register: "રજીસ્ટર",
            authority_login: "સત્તાવાળાનું લૉગિન",
            route_planner: "માર્ગ આયોજન",
            start_family: "ફેમિલી ટ્રેકિંગ શરૂ કરો",
            share_location: "સ્થાન શેર કરો",
            my_itinerary: "મારી યાત્રા",
            panic: "પેનિક",
            voice_control: "વોઇસ કંટ્રોલ શરૂ કરો ('panic' કહો)",
            active_alerts: "સક્રિય એલર્ટ્સ",
          },
          pa: {
            tourist_interface: "ਪਰ੍ਯਟਕ ਇੰਟਰਫੇਸ",
            authority_dashboard: "ਅਥੌਰਟੀ ਡੈਸ਼ਬੋਰਡ",
            analytics: "ਵਿਸ਼ਲੇਸ਼ਣ",
            login: "ਲੌਗਇਨ",
            register: "ਰਜਿਸਟਰ",
            authority_login: "ਅਥੌਰਟੀ ਲੌਗਇਨ",
            route_planner: "ਰੂਟ ਪਲੈਨਰ",
            start_family: "ਪਰਿਵਾਰ ਟ੍ਰੈਕਿੰਗ ਸ਼ੁਰੂ ਕਰੋ",
            share_location: "ਲੋਕੇਸ਼ਨ ਸਾਂਝੀ ਕਰੋ",
            my_itinerary: "ਮੇਰੀ ਯਾਤਰਾ",
            panic: "ਪੈਨਿਕ",
            voice_control: "ਵੌਇਸ ਕੰਟਰੋਲ ਸ਼ੁਰੂ ਕਰੋ ('panic' ਕਹੋ)",
            active_alerts: "ਸਕ੍ਰਿਆ ਚੇਤਾਵਨੀਆਂ",
          },
          or: {
            tourist_interface: "ପର୍ଯ୍ୟଟକ ଇଣ୍ଟରଫେସ",
            authority_dashboard: "କର୍ତ୍ତୃପକ୍ଷ ଡାଶବୋର୍ଡ",
            analytics: "ବିଶ୍ଳେଷଣ",
            login: "ଲଗ୍-ଇନ୍",
            register: "ରେଜିଷ୍ଟର୍",
            authority_login: "କର୍ତ୍ତୃପକ୍ଷ ଲଗିନ୍",
            route_planner: "ରୁଟ୍ ପ୍ଲାନର୍",
            start_family: "ପରିବାର ଟ୍ରାକିଂ ଆରମ୍ଭ କରନ୍ତୁ",
            share_location: "ଅବସ୍ଥାନ ସେୟାର୍ କରନ୍ତୁ",
            my_itinerary: "ମୋ ଯାତ୍ରା",
            panic: "ପ୍ୟାନିକ୍",
            voice_control: "ଭଏସ୍ କଣ୍ଟ୍ରୋଲ ଆରମ୍ଭ କରନ୍ତୁ ('panic' କୁହନ୍ତୁ)",
            active_alerts: "ସକ୍ରିୟ ସତର୍କତା",
          },
          as: {
            tourist_interface: "পর্যটক ইণ্টাৰফেচ",
            authority_dashboard: "কর্তৃপক্ষ ডেশ্বৰ্ড",
            analytics: "বিশ্লেষণ",
            login: "লগিন",
            register: "ৰেজিষ্টাৰ",
            authority_login: "কর্তৃপক্ষ লগিন",
            route_planner: "ৰুট পৰিকল্পনা",
            start_family: "পৰিয়াল ট্ৰেকিং আৰম্ভ কৰক",
            share_location: "অৱস্থান শ্বেয়াৰ কৰক",
            my_itinerary: "মʼৰ ভ্ৰমণসূচী",
            panic: "পেনিক",
            voice_control: "ভয়েছ নিয়ন্ত্ৰণ আৰম্ভ কৰক ('panic' ক'ব)",
            active_alerts: "সক্ৰিয় সতৰ্কবাণী",
          },
        };
        function applyLanguage() {
          const tr = I18N[uiLanguage] || I18N.en;
          document.querySelectorAll("[data-i18n]").forEach((el) => {
            const key = el.getAttribute("data-i18n");
            if (tr[key]) el.textContent = tr[key];
          });
        }

        updateCounts();
        applyLanguage();
      })();
    </script>
  </body>
</html>